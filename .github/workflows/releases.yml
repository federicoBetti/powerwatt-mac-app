name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.1.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-latest
    env:
      SPARKLE_VERSION: "2.8.1"
      POSTHOG_API_KEY: ${{ secrets.POSTHOG_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create tag (if workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        id: create_tag
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ github.event.inputs.version }}"
          # Ensure version starts with 'v'
          if [[ ! "$VERSION" =~ ^v ]]; then
            VERSION="v${VERSION}"
          fi
          # Check if tag already exists
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "Tag $VERSION already exists" >&2
            exit 1
          fi
          # Create annotated tag
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$VERSION" -m "PowerWatt $VERSION"
          git push origin "$VERSION"
          echo "tag=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Resolve Swift packages
        shell: bash
        run: |
          set -euo pipefail
          xcodebuild \
            -project "PowerWatt.xcodeproj" \
            -scheme "PowerWatt" \
            -resolvePackageDependencies

      - name: Compute version
        id: version
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Use the tag we just created
            TAG_NAME="${{ steps.create_tag.outputs.tag }}"
          else
            # Use the tag from the push event
            TAG_NAME="${GITHUB_REF_NAME}"
          fi
          VERSION="${TAG_NAME#v}"
          echo "tag=${TAG_NAME}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Build (Release)
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "${POSTHOG_API_KEY:-}" ]]; then
            echo "Missing secret POSTHOG_API_KEY" >&2
            exit 1
          fi

          xcodebuild \
            -project "PowerWatt.xcodeproj" \
            -scheme "PowerWatt" \
            -configuration Release \
            -destination "platform=macOS" \
            -derivedDataPath "build/DerivedData" \
            MARKETING_VERSION="${{ steps.version.outputs.version }}" \
            CURRENT_PROJECT_VERSION="${{ github.run_number }}" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            POSTHOG_API_KEY="${POSTHOG_API_KEY}" \
            build

          APP_PATH="build/DerivedData/Build/Products/Release/PowerWatt.app"
          if [[ ! -d "$APP_PATH" ]]; then
            echo "Expected app not found at $APP_PATH" >&2
            exit 1
          fi

          echo "APP_PATH=$APP_PATH" >> "$GITHUB_ENV"

      - name: Ad-hoc codesign app
        shell: bash
        run: |
          set -euo pipefail
          codesign --force --deep --sign - --entitlements "PowerWatt/PowerWatt.entitlements" "$APP_PATH"
          codesign --verify --deep --strict "$APP_PATH"

      - name: Package ZIP + DMG
        shell: bash
        run: |
          set -euo pipefail

          rm -rf dist dmgroot updates
          mkdir -p dist dmgroot updates

          # Sparkle prefers .zip archives
          ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "dist/PowerWatt.zip"

          # DMG for human-friendly download
          cp -R "$APP_PATH" "dmgroot/PowerWatt.app"
          # Provide the usual drag-to-Applications install target
          ln -s /Applications "dmgroot/Applications"
          hdiutil create -volname "PowerWatt" -srcfolder "dmgroot" -ov -format UDZO "dist/PowerWatt.dmg"

          # PKG for one-click install into /Applications
          pkgbuild --component "$APP_PATH" --install-location "/Applications" "dist/PowerWatt.pkg"

          # Appcast generation input
          cp "dist/PowerWatt.zip" "updates/PowerWatt.zip"

      - name: Cache Sparkle tools
        id: cache-sparkle
        uses: actions/cache@v4
        with:
          path: sparkle-tools
          key: sparkle-tools-${{ env.SPARKLE_VERSION }}

      - name: Download Sparkle tools
        if: steps.cache-sparkle.outputs.cache-hit != 'true'
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p sparkle-tools
          curl -L -o "sparkle-tools/Sparkle-${SPARKLE_VERSION}.tar.xz" "https://github.com/sparkle-project/Sparkle/releases/download/${SPARKLE_VERSION}/Sparkle-${SPARKLE_VERSION}.tar.xz"
          tar -xf "sparkle-tools/Sparkle-${SPARKLE_VERSION}.tar.xz" -C "sparkle-tools"

      - name: Export Sparkle binary path
        shell: bash
        run: |
          set -euo pipefail
          echo "SPARKLE_BIN=$(pwd)/sparkle-tools/bin" >> "$GITHUB_ENV"

      - name: Generate appcast.xml
        shell: bash
        env:
          SPARKLE_EDDSA_PRIVATE_KEY_BASE64: ${{ secrets.SPARKLE_EDDSA_PRIVATE_KEY_BASE64 }}
        run: |
          set -euo pipefail

          if [[ -z "${SPARKLE_EDDSA_PRIVATE_KEY_BASE64:-}" ]]; then
            echo "Missing secret SPARKLE_EDDSA_PRIVATE_KEY_BASE64" >&2
            exit 1
          fi

          KEY_FILE="sparkle_ed25519_private_key"
          # Sparkle expects the EdDSA private key file to be a UTF-8 string (as produced by `generate_keys -x`).
          # Store that key string in the GitHub secret and write it directly to the file.
          printf '%s' "${SPARKLE_EDDSA_PRIVATE_KEY_BASE64}" > "$KEY_FILE"

          # Must end with "/" or URL resolution will drop the tag component (Sparkle resolves relative paths)
          DOWNLOAD_PREFIX="https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/"

          "$SPARKLE_BIN/generate_appcast" \
            --ed-key-file "$KEY_FILE" \
            --download-url-prefix "$DOWNLOAD_PREFIX" \
            "updates"

          rm -f "$KEY_FILE"

          if [[ ! -f "updates/appcast.xml" ]]; then
            echo "Appcast was not generated" >&2
            exit 1
          fi

          # Update Pages appcast on main branch
          git fetch origin main
          git checkout -B main origin/main
          cp "updates/appcast.xml" "docs/appcast.xml"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "${{ steps.version.outputs.tag }}"
          tag_name: "${{ steps.version.outputs.tag }}"
          files: |
            dist/PowerWatt.dmg
            dist/PowerWatt.pkg
            dist/PowerWatt.zip

      - name: Commit updated docs/appcast.xml
        shell: bash
        run: |
          set -euo pipefail

          # Commit only if the file actually changed
          if git diff --quiet -- "docs/appcast.xml"; then
            echo "No changes in docs/appcast.xml; skipping commit."
            exit 0
          fi

          git add "docs/appcast.xml"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "Update Sparkle appcast for ${{ steps.version.outputs.tag }}"

      - name: Push appcast update (retry)
        shell: bash
        run: |
          set -euo pipefail

          # Retry to reduce flakiness from transient GitHub/network issues
          for attempt in 1 2 3 4 5; do
            if git push origin main; then
              exit 0
            fi
            echo "git push failed (attempt ${attempt}/5). Retrying..." >&2
            sleep $((attempt * 15))
          done

          echo "git push failed after retries." >&2
          exit 1
